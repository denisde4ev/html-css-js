<!DOCTYPE html>
<html class="h-full" lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App</title>
    <script src="./lib/tw.js"></script>
    <script src="./lib/umbrella.js"></script>
    <script>
      u.prototype.removeAttr = function(attr) {
      	if (!attr || typeof attr !== 'string') throw new TypeError('att should be string');
      
      	//const attrs = attr.split(); // Support for removing multiple attributes
      	return this.each( el => el.removeAttribute(attr) );
      };
      
      
    </script>
    <script src="./lib/editable-tab.js" async></script>
    <style>
      dialog {
      	inset-inline-start: 0;
      	inset-inline-end: 0;
      	margin: auto;
      }
      dialog::backdrop {
      	background: rgba(0, 0, 0, 0.5);
      }
      li.item:not(:hover) > .i { visibility: hidden; }
      _.i.dragable-icon:before {
      	content: "";
      	display: inline-block;
      	width: 3Q;
      	height: 3Q;
      	margin-right: 5Q;
      	color: gray;
      	/* disable for now*/
      	_background: currentColor;
      	_box-shadow:
      		6Q 0 0,
      		0 -6Q 0,
      		6Q -6Q 0,
      		0 -12Q 0,
      		6Q -12Q 0
      	;
        border-radius: 9Q;
      }
      
    </style>
  </head>
  <body class="
			h-full
			bg-[#272822]
			dark:bg-[#1a1b16]
			text-[#f8f8f2]
			dark:text-[#f8f8f2]
			flex items-center
			justify-center
			min-h-screen
		">
    <script>
      function TodoTask(...args) { return TodoTask.prototype._realConstructor.call(this, ...args); }
      window.TodoTask = TodoTask;
      
      function TodoAppControl(...args) { return TodoAppControl.prototype._realConstructor.call(this, ...args); }
      window.TodoAppControl = TodoAppControl;
      
    </script>
    <template id="task-template">
      <li class="item 
					flex
					items-start
					gap-2
					p-2
					rounded
					bg-[#272822]
					dark:bg-[#1a1b16]
				">
        <div class="i dragable-icon"></div>
        <input class="mt-1 accent-[#fd971f]" type="checkbox">
        <script>
          TodoAppControl.prototype.setDone = function(id, done) {
          	var idx = this.tasks.findIndex(function(t) { return t.id === id; });
          	if (idx === -1) return;
          	this.tasks[idx].done = done;
          	this.save();
          	this.taskMap.get(id).update(this.tasks[idx]);
          };
          
        </script><span class="
						flex-1
						whitespace-pre-line
						break-words
						font-mono
						px-1
						rounded
						cursor-pointer
						transition-colors
						outline-none
					"></span>
        <script>
          TodoTask.prototype.updateStyle = function() {
          	const isDone = this.data.done;
          	u(this.span)
          		.toggleClass('text-[#75715e] dark:text-[#75715e] line-through', isDone)
          		.toggleClass('text-[#f8f8f2] dark:text-[#f8f8f2]', !isDone)
          	;
          };
          
        </script>
        <button class="edit-btn px-2 py-1 rounded bg-[#fd971f] text-white text-xs font-bold ml-1" type="button" aria-label="Edit task">✎</button>
        <script>
          TodoTask.prototype.startEdit = function() {
          	if (this.span.isContentEditable) return;
          	var self = this;
          	var uSpan = u(self.span);
          
          	self.span.contentEditable = "true";
          	uSpan.addClass('ring-2 ring-[#fd971f] bg-[#49483e]');
          	uSpan.attr({ role: "textbox", tabindex: "0" });
          	self.span.focus();
          	document.execCommand('selectAll', false, null);
          	document.getSelection().collapseToEnd();
          
          	function editOnKeydown(e) {
          		if (
          			e.shiftKey ||
          			e.ctrlKey ||
          			e.altKey ||
          			e.metaKey ||
          		false) return;
          		
          		var action;
          		if (0) ;
          		else if (e.key === 'Enter') action = 'save';
          		else if (e.key === 'Escape') action = 'discard';
          		else return;
          		// when finished editing:
          		
          		self.span.contentEditable = "false";
          		uSpan.removeClass('ring-2 ring-[#fd971f] bg-[#49483e]');
          		uSpan.removeAttr('role');
          		uSpan.removeAttr('tabindex');
          		if (action === 'save') {
          			var newText = self.span.textContent;
          			if (newText && newText !== self.data.text) {
          				self.control.setText(self.data.id, newText);
          			} else if (!newText) {
          				self.control.remove(self.data.id);
          			} else {
          				self.updateStyle();
          			}
          		} else if (action === 'discard') {
          			debugger;
          			self.updateStyle();
          		} else throw new Error('err 4');
          		
          		e.preventDefault();
          	}
          
          	// umbrella.js does not support {once: true}, so use native for 'blur'
          	//self.span.addEventListener('blur', editOnKeydown, { once: true });
          	uSpan.on('keydown', editOnKeydown);
          };
          
        </script>
        <button class="up-btn 
						px-2
						py-1
						rounded
						bg-gray-700
						dark:bg-gray-800
						text-xs
						font-bold
						mr-1
						text-white
					" type="button" aria-label="Move up">↑</button>
        <button class="down-btn 
						px-2
						py-1
						rounded
						bg-gray-700
						dark:bg-gray-800
						text-xs
						font-bold
						text-white
					" type="button" aria-label="Move down">↓</button>
        <script>
          TodoAppControl.prototype.setupArrowKeys = function() {
          	this.list.addEventListener('keydown', function(e) {
          		if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown') return;
          		var active = document.activeElement;
          		if (!this.list.contains(active)) return;
          		var li = active;
          		if (li.tagName !== 'LI') li = li.closest('li');
          		if (!li) return;
          		var items = Array.prototype.slice.call(
          			this.list.querySelectorAll('li:not(.task-template)')
          		);
          		var idx = items.indexOf(li);
          		if (idx === -1) return;
          		var nextIdx = e.key === 'ArrowUp' ? idx - 1 : idx + 1;
          		if (!( 0 <= nextIdx&&nextIdx < items.length)) return;
          		e.preventDefault();
          		items[nextIdx].focus();
          	}.bind(this));
          	this.list.addEventListener('focusin', function(e) {
          		var li = e.target;
          		if (li.tagName !== 'LI') li = li.closest('li');
          		if (li) li.setAttribute('tabindex', '-1');
          	});
          };
          
          TodoAppControl.prototype.move = function(id, /* could be `1` or `-1` (no null or undefined) */ direction) {
          	var idx = this.tasks.findIndex(function(t) { return t.id === id; });
          	var newIdx = idx + direction;
          	if (idx === -1 || newIdx < 0 || newIdx >= this.tasks.length) return;
          	var tempOrder = this.tasks[idx].order;
          	this.tasks[idx].order = this.tasks[newIdx].order;
          	this.tasks[newIdx].order = tempOrder;
          	var temp = this.tasks[idx];
          	this.tasks[idx] = this.tasks[newIdx];
          	this.tasks[newIdx] = temp;
          	this.save();
          	for (var i = 0; i < this.tasks.length; ++i) {
          		var t = this.tasks[i];
          		t.order = i;
          		this.taskMap.get(t.id).update(t);
          		this.list.children[i].style.order = i;
          	}
          	this.updateMoveButtons();
          };
          TodoAppControl.prototype.updateMoveButtons = function() {
          	for (var i = 0; i < this.tasks.length; ++i) {
          		var task = this.tasks[i];
          		var taskObj = this.taskMap.get(task.id);
          		if (taskObj) {
          			taskObj.upBtn.disabled = i === 0;
          			taskObj.downBtn.disabled = i === this.tasks.length - 1;
          			taskObj.setDisabledStyle(taskObj.upBtn, taskObj.upBtn.disabled);
          			taskObj.setDisabledStyle(taskObj.downBtn, taskObj.downBtn.disabled);
          		}
          	}
          };
        </script>
        <script>
          TodoTask.prototype.setDisabledStyle = function(btn, isDisabled) {
          	u(btn).toggleClass(
          		"bg-gray-400 dark:bg-gray-700 text-gray-200 dark:text-gray-500 cursor-not-allowed opacity-60",
          		isDisabled,
          	);
          };
          
        </script>
        <button class="del-btn ml-2 px-2 py-1 rounded bg-red-500 text-white text-xs font-bold hover:bg-red-600" type="button" aria-label="Delete task">✕</button>
        <script>
          TodoAppControl.prototype.remove = function(id) {
          	var idx = this.tasks.findIndex(function(t) { return t.id === id; });
          	if (idx === -1) return;
          	this.tasks[idx].visible = false;
          	this.save();
          	this.taskMap.get(id).hide();
          	this.tasks.splice(idx, 1);
          	this.render();
          };
          TodoTask.prototype.remove = function() {
          	this.data.visible = false;
          	this.li.style.display = 'none';
          };
          
        </script>
        <script>
          TodoTask.prototype.hide = function() {
          	this.data.visible = false;
          	this.li.style.display = 'none';
          };
          TodoTask.prototype.show = function() {
          	this.data.visible = true;
          	this.li.style.display = '';
          };
          
        </script>
        <script>
          TodoTask.prototype.init = function() {
          	this.li.setAttribute('data-id', this.data.id);
          	this.li.style.display = this.data.visible === false ? 'none' : '';
          	this.li.style.order = this.data.order;
          	this.li.setAttribute('tabindex', '-1');
          	this.checkbox.checked = !!this.data.done;
          	this.span.textContent = this.data.text;
          	this.updateStyle();
          
          	this.checkbox.onclick = null;
          	this.span.onclick = null;
          	this.span.ondblclick = null;
          	this.editBtn.onclick = null;
          	this.upBtn.onclick = null;
          	this.downBtn.onclick = null;
          	this.delBtn.onclick = null;
          
          	// Checkbox
          	this.checkbox.onclick = () => {
          		this.control.setDone(this.data.id, !this.data.done);
          	};
          
          	// Double click to enable and edit (attach before single click)
          	this.span.ondblclick = (e) => {
          		if (this.data.done) {
          			this.control.setDone(this.data.id, false);
          			setTimeout(() => this.startEdit(), 0);
          		} else {
          			this.startEdit();
          		}
          	};
          
          	// Edit button only if not done
          	if (!this.data.done) {
          		this.editBtn.style.display = '';
          		this.editBtn.onclick = () => this.startEdit();
          	} else {
          		this.editBtn.style.display = 'none';
          	}
          
          	// Click to toggle done/enable
          	this.span.onclick = (e) => {
          		if (this.span.isContentEditable) return;
          
          		this.control.setDone(this.data.id, !this.data.done);
          	};
          
          	// Move up/down
          	this.upBtn.onclick = () => this.control.move(this.data.id, -1);
          	this.downBtn.onclick = () => this.control.move(this.data.id, 1);
          	// Remove
          	this.delBtn.onclick = () => this.control.remove(this.data.id);
          
          	// Disabled state for up/down
          	this.upBtn.disabled = this.data.order === 0;
          	this.downBtn.disabled = this.data.order === this.control.tasks.length - 1;
          	this.setDisabledStyle(this.upBtn, this.upBtn.disabled);
          	this.setDisabledStyle(this.downBtn, this.downBtn.disabled);
          };
          TodoTask.prototype.update = function(data) {
          	this.data = data;
          	this.init();
          };
        </script>
      </li>
    </template>
    <script>
      {
      	//u(document.getElementById('#task-template').content).find('script').each(script => {
      	
      	//u(u('#task-template').nodes[0].content).find('script').each(script => {
      	//	document.head.insertAdjacentElement('beforeEnd', script);
      	//});
      	u('head').append(  u( u('#task-template').nodes[0].content ).find('script')  );
      }
      
    </script>
    <main class="container w-full max-w-md mx-auto p-4 rounded-lg shadow-lg bg-[#3e3d32] dark:bg-[#23241f]">
      <h1 class="
					text-2xl
					font-bold
					mb-4
					text-center
					text-[#fd971f]
					dark:text-[#fd971f]
				">Todo App</h1>
      <div class="
					flex
					justify-between
					items-center
					mb-4
				"><span class="font-semibold text-lg">Task List</span>
        <button class="px-3 py-1 rounded bg-[#fd971f] text-white font-medium hover:bg-orange-600 transition-colors" id="open-modal" type="button" aria-label="Add new task">+ Add Task</button>
      </div>
      <script>
        TodoTask.prototype._realConstructor = function(data, control, li) {
        	this.data = data;
        	this.control = control;
        	this.li = li;
        	this.checkbox = li.querySelector('input[type=checkbox]');
        	this.span = li.querySelector('span');
        	this.editBtn = li.querySelector('.edit-btn');
        	this.upBtn = li.querySelector('.up-btn');
        	this.downBtn = li.querySelector('.down-btn');
        	this.delBtn = li.querySelector('.del-btn');
        	this.init();
        };
        
      </script>
      <script>
        TodoAppControl.prototype._realConstructor = function TodoAppControl() {
        	this.list = document.getElementById('todo-list');
        	this.template = document.getElementById('task-template');
        	this.tasks = [];
        	this.taskMap = new Map();
        	this.load();
        	this.render();
        	this.setupModal();
        	this.setupArrowKeys();
        };
        
        TodoAppControl.prototype.generateId = function() {
        	return '_' + Math.random().toString(36).substr(2, 9);
        };
        TodoAppControl.prototype.load = function() {
        	var data = [];
        	try {
        		data = JSON.parse(localStorage.getItem('tasks')) || [];
        	} catch {}
        	data = data.filter(function(t) { return t && t.text && typeof t.text === 'string'; });
        	data.forEach((t, i) => {
        		if (!t.id) t.id = this.generateId();
        		t.order = i;
        		t.visible = t.visible !== false;
        	});
        	this.tasks = data;
        };
        TodoAppControl.prototype.save = function() {
        	localStorage.setItem('tasks', JSON.stringify(this.tasks));
        };
        TodoAppControl.prototype.render = function() {
        	// Remove all current li children
        	u(this.list).empty();
        
        	// Add li for each task
        	for (var i = 0; i < this.tasks.length; ++i) {
        		var task = this.tasks[i];
        		if (task.visible === false) continue;
        		var li = this.template.content.firstElementChild.cloneNode(true);
        		u(this.list).append(li);
        	};
        
        	// Map and update
        	var lis = u(this.list).children().nodes;
        	this.taskMap.clear();
        	var liIndex = 0;
        	for (var i = 0; i < this.tasks.length; ++i) {
        		var task = this.tasks[i];
        		if (task.visible === false) continue;
        		var li = lis[liIndex++];
        		if (!li) continue;
        		if (!li.todoTask) {
        			li.todoTask = new window.TodoTask(task, this, li);
        		} else {
        			li.todoTask.update(task);
        		};
        		this.taskMap.set(task.id, li.todoTask);
        		li.style.order = i;
        	}
        	this.updateMoveButtons();
        };
        
      </script>
      <ul class="space-y-2 grid" id="todo-list" aria-label="Todo list" style="display: grid; grid-auto-rows: minmax(0, auto);"></ul>
      <dialog class="rounded-lg shadow-xl p-0 border-0 bg-[#3e3d32] dark:bg-[#23241f] text-[#f8f8f2] dark:text-[#f8f8f2] w-full max-w-md" id="add-modal">
        <form class="flex flex-col gap-3 p-6 pt-4" id="todo-form" method="dialog" aria-label="Add new task">
          <div class="
							flex
							justify-between
							items-center
							mb-2
						">
            <h2 class="
								text-xl
								font-bold
								text-[#fd971f]
								dark:text-[#fd971f]
							">New Task</h2>
            <button class="
								text-2xl
								font-bold
								text-[#fd971f]
								dark:text-[#fd971f]
								hover:text-orange-400
								transition-colors
								px-2
								py-0
								rounded&quot;,
								aria-label=&quot;Close modal
							" id="close-modal" type="button" title="Close">×</button>
          </div>
          <textarea class="
							resize-y
							min-h-[60px]
							max-h-40
							p-2
							rounded
							border
							border-[#75715e]
							dark:border-[#75715e]
							focus:outline-none
							focus:ring-2
							focus:ring-[#fd971f]
							bg-[#49483e]
							dark:bg-[#49483e]
							text-[#f8f8f2]
							font-mono
						" id="new-task" placeholder="Type your task here..." aria-label="Task description" required></textarea>
          <div>
            <button class="
								flex
								justify-end
								
								px-3
								py-1
								rounded
								bg-[#fd971f]
								text-white
								font-medium
								hover:bg-orange-600
								transition-colors
							" type="submit" aria-label="Add task">Add Task</button>
            <script>
              TodoAppControl.prototype.add = function(text) {
              	if (!text || !text.length) return;
              	var newTask = {
              		id: this.generateId(),
              		text: text,
              		done: false,
              		order: this.tasks.length,
              		visible: true
              	};
              	this.tasks.push(newTask);
              	this.save();
              	this.render();
              };
            </script>
          </div>
        </form>
      </dialog>
      <script>
        TodoAppControl.prototype.setupModal = function() {
        	var modal = document.getElementById('add-modal');
        	var openModalBtn = document.getElementById('open-modal');
        	var closeModalBtn = document.getElementById('close-modal');
        	var todoForm = document.getElementById('todo-form');
        	var newTaskTextarea = document.getElementById('new-task');
        
        	openModalBtn.addEventListener('click', function() {
        		modal.showModal();
        		setTimeout(function() { newTaskTextarea.focus(); }, 100);
        	});
        
        	closeModalBtn.addEventListener('click', function() {
        		modal.close();
        	});
        
        	modal.addEventListener('click', function(event) {
        		var rect = modal.getBoundingClientRect();
        		if (
        			event.clientY < rect.top ||
        			event.clientY > rect.bottom ||
        			event.clientX < rect.left ||
        			event.clientX > rect.right
        		) {
        			modal.close();
        		}
        	});
        
        	todoForm.addEventListener('submit', ((e) => {
        		e.preventDefault();
        		var text = newTaskTextarea.value;
        		if (text && text.length) {
        			this.add(text);
        			todoForm.reset();
        			modal.close();
        		}
        	}).bind(this));
        };
        
      </script>
      <script>
        TodoAppControl.prototype.setText = function(id, text) {
        	var idx = this.tasks.findIndex(function(t) { return t.id === id; });
        	if (idx === -1) return;
        	this.tasks[idx].text = text;
        	this.save();
        	this.taskMap.get(id).update(this.tasks[idx]);
        };
        
      </script>
      <script>
        //window.addEventListener('DOMContentLoaded', function() {
        u(document).on('DOMContentLoaded', function() {
        	window.todoAppControl = new window.TodoAppControl();
        });
      </script>
    </main>
  </body>
</html>